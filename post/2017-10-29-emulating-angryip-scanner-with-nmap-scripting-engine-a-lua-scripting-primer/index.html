<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Emulating Angry IP Scanner with nmap scripting engine - A lua scripting primer - Ephemeral Dance Of Electrons</title>
<meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="tmzh"><meta name=description content="Often we have to discover the devices on a network. I use a very simple nmap command for performing a pingsweep.
sudo nmap -sn &amp;lt;subnet or ip range&amp;gt;
On my Windows PC, I wrap it around in a batch script and place it in the search PATH. On Linux, it can be dropped in as an alias in bashrc.
"><meta name=keywords content="blog,code,recreational"><meta name=generator content="Hugo 0.122.0 with theme even"><link rel=canonical href=https://tmzh.github.io/post/2017-10-29-emulating-angryip-scanner-with-nmap-scripting-engine-a-lua-scripting-primer/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><meta property="og:title" content="Emulating Angry IP Scanner with nmap scripting engine - A lua scripting primer"><meta property="og:description" content="Often we have to discover the devices on a network. I use a very simple nmap command for performing a pingsweep.
sudo nmap -sn <subnet or ip range>
On my Windows PC, I wrap it around in a batch script and place it in the search PATH. On Linux, it can be dropped in as an alias in bashrc."><meta property="og:type" content="article"><meta property="og:url" content="https://tmzh.github.io/post/2017-10-29-emulating-angryip-scanner-with-nmap-scripting-engine-a-lua-scripting-primer/"><meta property="article:section" content="post"><meta property="article:published_time" content="2017-10-29T12:08:28+00:00"><meta property="article:modified_time" content="2017-10-29T12:08:28+00:00"><meta itemprop=name content="Emulating Angry IP Scanner with nmap scripting engine - A lua scripting primer"><meta itemprop=description content="Often we have to discover the devices on a network. I use a very simple nmap command for performing a pingsweep.
sudo nmap -sn <subnet or ip range>
On my Windows PC, I wrap it around in a batch script and place it in the search PATH. On Linux, it can be dropped in as an alias in bashrc."><meta itemprop=datePublished content="2017-10-29T12:08:28+00:00"><meta itemprop=dateModified content="2017-10-29T12:08:28+00:00"><meta itemprop=wordCount content="1363"><meta itemprop=keywords content="lua,nmap,network-discovery,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Emulating Angry IP Scanner with nmap scripting engine - A lua scripting primer"><meta name=twitter:description content="Often we have to discover the devices on a network. I use a very simple nmap command for performing a pingsweep.
sudo nmap -sn <subnet or ip range>
On my Windows PC, I wrap it around in a batch script and place it in the search PATH. On Linux, it can be dropped in as an alias in bashrc."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Ephemeral Dance Of Electrons</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Ephemeral Dance Of Electrons</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Emulating Angry IP Scanner with nmap scripting engine - A lua scripting primer</h1><div class=post-meta><span class=post-time>2017-10-29</span><div class=post-category><a href=/categories/scripting/>Scripting</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#nse-script-structure>NSE Script structure</a></li><li><a href=#diving-in>Diving In</a></li><li><a href=#code-walkthrough>Code Walkthrough</a><ul><li><a href=#rule-section>RULE section</a></li><li><a href=#action-section>ACTION Section</a></li></ul></li><li><a href=#where-to-go-next>Where to go next</a></li></ul></li></ul></nav></div></div><div class=post-content><p>Often we have to discover the devices on a network. I use a very simple nmap command for performing a pingsweep.</p><p><code>sudo nmap -sn &lt;subnet or ip range></code></p><p>On my Windows PC, I wrap it around in a batch script and place it in the search PATH. On Linux, it can be dropped in as an alias in bashrc.</p><p>It is handy, but not complete. I would like to have some extra information such as hostnames (collected by various means not just DNS reverse lookup), platform info etc., Such details are available in tools such as AngryIP scanner, but I don&rsquo;t prefer to launch a GUI tool for single task and keep it running until the task is done.</p><p>So let us try to implement a similar function using nmap script. There are existing scripts in nmap which performs advanced discovery and reconnaissance, but we want something lightweight, more generic and customizable to support more protocols. Nmap scripts run on top of Nmap Scripting Engine which runs on Lua. Learning it would expand the scope of these tools from just being a capable tool to a powerful tool with limitless possibilities.</p><p>Although this was my first attempt at Lua scripting, the endeavour turned out to be fairly simple. True it was not without its share of frustrations, most of which were related to wrapping my head around the way NSE (Nmap Scripting Engine) tosses the data around and lua data structures. But once you get the hang of it, it is really simple. So without much ado, let us get started.</p><h2 id=nse-script-structure>NSE Script structure</h2><p>A basic NSE script will have the following 3 sections:</p><ul><li>The Head section is for meta information about the script. We need not worry about it for primer purpose but it is a good habit to put documentation info here while packaging the script for production. This section also feeds in to the NSE Documentation module (<a href=https://nmap.org/book/nsedoc.html>NSEDoc</a>) which provides a consistent way to represent the meta information about our script.</li><li>The RULE section determines the scope of the script. It basically acts as a filter of nmap port-scan results that gets filtered to the Action section. The rule section should contain one of the following functions:<ul><li>prerule()</li><li>hostrule(host)</li><li>portrule(host, port)</li><li>postrule()</li></ul></li><li>The Action section is mostly the brain of the script (although rule section can also contain some of the script logic). This section contains an Action section which reads data from the nmap scanning engine and carries out the script logic. The value returned by this function is also printed on the screen and captured by other nmap output methods. Note that this script is executed iteratively over either list of hosts or a list of (host, port) tuples. The ACTION section is indicated by the presence of a function named <code>action</code>.</li></ul><h2 id=diving-in>Diving In</h2><p>So let us go ahead and create a basic script. Our script will scan the target network and fetch the hostname from NETBIOS. Create a script file with .nse (I used host-discover.nse) extension as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>netbios</span> <span class=o>=</span> <span class=n>require</span> <span class=s2>&#34;netbios&#34;</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>shortport</span> <span class=o>=</span> <span class=n>require</span> <span class=s2>&#34;shortport&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- The Rule Section --</span>
</span></span><span class=line><span class=cl><span class=n>portrule</span> <span class=o>=</span> <span class=n>shortport.portnumber</span><span class=p>({</span><span class=mi>137</span><span class=p>},</span> <span class=s2>&#34;udp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- The Action Section --</span>
</span></span><span class=line><span class=cl><span class=n>action</span> <span class=o>=</span> <span class=kr>function</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>nbt_status</span><span class=p>,</span> <span class=n>netbios_name</span> <span class=o>=</span> <span class=n>netbios.get_server_name</span><span class=p>(</span><span class=n>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>netbios_name</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></td></tr></table></div></div><p>Now run this script against your local network as below:</p><p><code>nmap --script host-discover.nse 10.1.1.0/24 -sU -p 137</code></p><p>Now take a minute or two to let this sink in&mldr; we just created our very own NETBIOS scanner, all in just 7 lines of functional code. There are dedicated standalone <a href=http://unixwiz.net/tools/nbtscan.html>tools</a> that performs this singular task and we managed to do it using nmap. With just a little more effort, we can add more bells and whistles to this.</p><p>The magic that enables this are the excellent inbuilt scanning mechanisms of nmap and hot-pluggable libraries that carry out much of the grunt. By scripting in NSE, we can tap in to this massive capabilities of nmap and automate to our needs. Let us now see how this script works.</p><h2 id=code-walkthrough>Code Walkthrough</h2><p>In this script there is no HEAD section. So we start by importing the libraries needed for our script. In Lua, modules are included using <code>require</code> function. And we assign the module to a local variable in order to access its namespace (i.e, call the methods that belong to the module).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>netbios</span> <span class=o>=</span> <span class=n>require</span> <span class=s2>&#34;netbios&#34;</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>shortport</span> <span class=o>=</span> <span class=n>require</span> <span class=s2>&#34;shortport&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>The purpose of these libraries will be evident in the later section.</p><h3 id=rule-section>RULE section</h3><p>Next we move to the RULE section. Notice that in Lua, comments are prepended by <code>--</code> sequence.</p><p>As mentioned earlier, RULE section acts as filter to identify hosts or ports relevant to our script. Since our script is only interested with NETBIOS query, we have to pick only the hosts that are listening on port UDP/137.</p><p>Since this is a common check, nmap includes a &lsquo;shortport&rsquo; module that provides shorthand functions to check port states. <code>shortport.portnumber</code> is one such function which will return true only for those ports and protocols listed in its arguements. Refer to online <a href=https://nmap.org/nsedoc/lib/shortport.html>documentation</a> for exact syntax of this function.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>-- The Rule Section --</span>
</span></span><span class=line><span class=cl><span class=n>portrule</span> <span class=o>=</span> <span class=n>shortport.portnumber</span><span class=p>({</span><span class=mi>137</span><span class=p>},</span> <span class=s2>&#34;udp&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>NOTE: The Rule section only filters port numbers passed on from the upper layer i.e, the original nmap scan. It doesn&rsquo;t trigger a port scan on its own. That is why when we launch the script, we had to specify port number explicitly (<code>nmap -sU -p U:137 &lt;host></code>). It is still possible to launch a port scan in this section, by calling nmap socket libraries but those are advanced scripting scenarios.</p></blockquote><h3 id=action-section>ACTION Section</h3><p>Next comes the ACTION section. Our action section here is a function that takes (host, port) as argument. It means the host object and port object are available to this function for evaluating logic. If we need other variables, they have to be declared outside this function.</p><p>Since for NETBIOS query we only need the host our action function will take only &lsquo;host&rsquo; as argument. We call the get_server_name function of <a href=https://nmap.org/nsedoc/lib/netbios.html#get_server_name>netbios</a> module. From the documentation we can see that this function returns two values, query status and query result which we capture under two local variables. For our simple task, we need not check the result status and go ahead to return the name variable directly. In Lua, if a variable doesn&rsquo;t exist it returns nil which is acceptable for our scenario.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>-- The Action Section --</span>
</span></span><span class=line><span class=cl><span class=n>action</span> <span class=o>=</span> <span class=kr>function</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>nbt_status</span><span class=p>,</span> <span class=n>netbios_name</span> <span class=o>=</span> <span class=n>netbios.get_server_name</span><span class=p>(</span><span class=n>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>netbios_name</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></td></tr></table></div></div><p>This returned value is processed by nmap scripting engine and printed in the output window.</p><blockquote><p>NOTE: In Lua functions are assigned to a variable like how we assign a string or integer value to a variable. In this case, code block defining the ACTION logic is assigned to a variable called action.
Lua functions are of the format <code>foo = function ( args ) body end</code>. It can be defined in a single line. To call the function, call the variable with argument such as <code>foo('bar')</code></p></blockquote><h2 id=where-to-go-next>Where to go next</h2><p>Since this is only a basic script, we have not customized the output format at all. The hostnames when available gets printed below each host-discovered. If you notice, the print action is executed within the ACTION function whose scope is limited to one host at a time. If we need our output to be consolidated in a tabular form, we can write a postrule function, store and retrieve our findings from nmap registry. Refer to my <a href=https://raw.githubusercontent.com/tmzh/Nmap-scripts/master/hostinfo-discover.nse>script</a> (work in progress) to see one way of doing it.</p><p>I strongly recommend to try this <a href=https://thesprawl.org/research/writing-nse-scripts-for-vulnerability-scanning/>walkthrough</a> as well. It greatly helped me to get started with NMAP scripting and understanding the way a NSE script is structured.</p><p>It won&rsquo;t hurt to improve your understanding of Lua programming language as well. I found this 15 minute <a href=http://tylerneylon.com/a/learn-lua/>primer</a> to be very useful.</p><p>Lastly the best resource for advanced nmap script writing is the existing script library. There are hundreds of scripts and libraries available, study and explore them to see different ways of tackling a challenge. Good luck scripting!</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>tmzh</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2017-10-29</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/lua/>lua</a>
<a href=/tags/nmap/>nmap</a>
<a href=/tags/network-discovery/>network-discovery</a></div><nav class=post-nav><a class=prev href=/post/2017-11-24-using-monte-carlo-simulation-to-model-ping-test-results/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Using Monte-Carlo Simulation to model ping test results</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/2017-08-24-using-a-bluetooth-serial-console-with-linux/><span class="next-text nav-default">Using a bluetooth serial console with linux</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=https://github.com/tmzh/tmzh.github.io class="iconfont icon-github" title=github></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span><span class=copyright-year>&copy;
2017 -
2024<span class=heart><i class="iconfont icon-heart"></i></span><span>tmzh</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script></body></html>